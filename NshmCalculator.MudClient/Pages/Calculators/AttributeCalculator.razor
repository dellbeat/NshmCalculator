@page "/attribute"

@using Blazored.LocalStorage
@using NshmCalculator.MudClient.Components
@using NshmCalculator.MudClient.Utilities
@using NshmCalculator.Shared
@using NshmCalculator.Shared.Models.PageModel
@inject ISyncLocalStorageService LocalStorage
@* ReSharper disable once IdentifierTypo *@
@inject ISnackbar Snackbar
@inject IDialogService Dialog
@* ReSharper disable once CollectionNeverUpdated.Local *@
@inject Dictionary<string,string> TipsDictionary

<PageTitle>逆水寒手游属性收益计算器</PageTitle>
<MudGrid>
    <MudItem xs="12">
        <MudPaper Class="d-flex align-center justify-center py-8">
            <MudStack AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4">属性收益计算器</MudText>
                <MudText Typo="Typo.h6" Align="Align.Center">
                    <MudChip Icon="@Icons.Material.Filled.Person" Color="Color.Tertiary">贴吧@星语困</MudChip>
                </MudText>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12">
        <MudPaper Class="pa-4 mt-4">
            <EditForm Model="@_attributePageModel" OnValidSubmit="Calculate">
                <DataAnnotationsValidator />
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Align="Align.Center">玩家基础面板</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="4" md="3">
                        <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseAttack" For="@(() => _attributePageModel.PageCalculateInfo.BaseAttack)" Label="基础攻击" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseBreakDefense" For="@(() => _attributePageModel.PageCalculateInfo.BaseBreakDefense)" Label="基础破防" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseElementAttack" For="@(() => _attributePageModel.PageCalculateInfo.BaseElementAttack)" Label="基础元素攻击" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseRestraint" For="@(() => _attributePageModel.PageCalculateInfo.BaseRestraint)" Label="基础克制数值" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseHit" For="@(() => _attributePageModel.PageCalculateInfo.BaseHit)" Label="基础命中" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseCriticalHits" For="@(() => _attributePageModel.PageCalculateInfo.BaseCriticalHits)" Label="基础会心" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseCriticalRate" For="@(() => _attributePageModel.PageCalculateInfo.BaseCriticalRate)" Label="基础会伤率" Adornment="Adornment.End" AdornmentText="%" AdornmentColor="Color.Dark" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseZtCriticalHitsRate" For="@(() => _attributePageModel.PageCalculateInfo.BaseZtCriticalHitsRate)" Label="周天会心率" Adornment="Adornment.End" AdornmentText="%" AdornmentColor="Color.Dark" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.BaseRestrainedRate" For="@(() => _attributePageModel.PageCalculateInfo.BaseRestrainedRate)" Label="基础克制百分比" Adornment="Adornment.End" AdornmentText="%" AdornmentColor="Color.Dark" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="12">
                         <MudDivider FlexItem="true"></MudDivider>
                     </MudItem>
                     <MudItem xs="12">
                         <MudText Typo="Typo.subtitle2" Align="Align.Center">敌方面板</MudText>
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageEnemyInfo.Defense" For="@(() => _attributePageModel.PageEnemyInfo.Defense)" Label="敌方防御" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageEnemyInfo.Block" For="@(() => _attributePageModel.PageEnemyInfo.Block)" Label="敌方格挡" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageEnemyInfo.AntiRestraint" For="@(() => _attributePageModel.PageEnemyInfo.AntiRestraint)" Label="敌方抵御" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageEnemyInfo.AntiCriticalHits" For="@(() => _attributePageModel.PageEnemyInfo.AntiCriticalHits)" Label="敌方会心抗性" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageEnemyInfo.AntiElementAttack" For="@(() => _attributePageModel.PageEnemyInfo.AntiElementAttack)" Label="敌方元素抗性" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageEnemyInfo.AirShield" For="@(() => _attributePageModel.PageEnemyInfo.AirShield)" Label="敌方气盾" HelperText="暂未实装，不参与计算" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="12" Class="d-flex align-center justify-center">
                         <MudChip Color="Color.Info">满命中：@_attributePageModel.PageEnemyInfo.FullHit</MudChip>
                        </MudItem>
                        <MudItem xs="12">
                            <MudDivider FlexItem="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Align="Align.Center">玩家新增面板</MudText>
                        </MudItem>
                        <MudItem xs="6" sm="4" md="3">
                            <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseAttack" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseAttack)" Label="新增攻击" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseRestraint" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseRestraint)" Label="新增克制" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseElementAttack" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseElementAttack)" Label="新增属性攻击" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseBreakDefense" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseBreakDefense)" Label="新增破防" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseHit" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseHit)" Label="新增命中" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseCriticalHits" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseCriticalHits)" HelperText="填入数字即可" Label="新增会心" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="6" sm="4" md="3">
                         <MudTextField ShrinkLabel @bind-Value="_attributePageModel.PageCalculateInfo.IncreaseCriticalRate" For="@(() => _attributePageModel.PageCalculateInfo.IncreaseCriticalRate)" HelperText="填入数字即可" Label="新增会伤率" Adornment="Adornment.End" AdornmentText="%" AdornmentColor="Color.Dark" Variant="Variant.Outlined" />
                     </MudItem>
                     <MudItem xs="12">
                         <MudDivider FlexItem="true" />
                     </MudItem>
                     <MudItem xs="12" Class="d-flex align-center justify-center">
                         <MudStack Row="true" Spacing="4">
                             <MudButton Variant="Variant.Filled" Color="Color.Info" Class="d-flex" ButtonType="ButtonType.Submit">计算</MudButton>
                             <MudButton Variant="Variant.Filled" Color="Color.Default" Class="d-flex" ButtonType="ButtonType.Button" OnClick="ShowTips">帮助说明</MudButton>
                         </MudStack>
                     </MudItem>
                 </MudGrid>
             </EditForm>
         </MudPaper>
     </MudItem>
     <MudItem xs="12">
         <MudPaper Class="d-flex align-center justify-center py-8">
             <MudGrid>
                 <MudItem xs="6" md="3" Class="d-flex align-center justify-center">
                     <MudChip Color="Color.Info">未会心伤害：@_attributePageModel.PageCalculateInfo.NonCriticalDamageFunValue.ToString("0.00")</MudChip>
                    </MudItem>
                    <MudItem xs="6" md="3" Class="d-flex align-center justify-center">
                        <MudChip Color="Color.Info">含命中会心伤害期望：@_attributePageModel.PageCalculateInfo.CriticalDamageFunValue.ToString("0.00")</MudChip>
                    </MudItem>
                    <MudItem xs="6" md="3" Class="d-flex align-center justify-center">
                        <MudChip Color="Color.Info">实际命中率：@_attributePageModel.PageCalculateInfo.HitRate.ToString("P2")</MudChip>
                    </MudItem>
                    <MudItem xs="6" md="3" Class="d-flex align-center justify-center">
                        <MudChip Color="Color.Info">实际会心率：@_attributePageModel.PageCalculateInfo.CalCriticalRate.ToString("P2")</MudChip>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @code {
    private readonly DialogParameters<TipsDialog> _tipsDialogParameters = new();
    private readonly DialogOptions _tipsDialogOptions = new();
    private AttributePageModel _attributePageModel = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        GetInfo();
        InitParameters();
        LocalStorage.SetItemAsString(ConstText.LastVisitName, "attribute");
    }

    private void InitParameters()
    {
        TipsDictionary.TryGetValue("attribute", out string? tips);
        if (string.IsNullOrEmpty(tips))
        {
            tips = "暂无内容";
        }
        _tipsDialogParameters.Add(nameof(TipsDialog.ContentText), new MarkupString(tips));
        _tipsDialogOptions.CloseButton = true;
    }

    private void SaveInfo()
    {
        LocalStorage.SetItem(nameof(_attributePageModel), _attributePageModel);
    }

    private void GetInfo()
    {
        _attributePageModel = LocalStorage.GetItem<AttributePageModel>(nameof(_attributePageModel)) ?? new();
    }

    private Task Calculate(EditContext context)
    {
        try
        {
            // double skillRate = 1;//技能倍率 目前未实装 注释保留
            double rate2 = 0.324;//系数2，暂定为固定值
            double rate1 = rate2 * 923;//系数1

            var calculateInfo = _attributePageModel.PageCalculateInfo;
            var enemyInfo = _attributePageModel.PageEnemyInfo;

            calculateInfo.BaseDamageFunValue = CalculatorUtility.CalculateBaseDamage(calculateInfo.BaseAttack, calculateInfo.BaseRestraint, calculateInfo.BaseElementAttack, calculateInfo.BaseBreakDefense, enemyInfo.Defense, enemyInfo.AntiRestraint, rate1, rate2);
            calculateInfo.NonCriticalDamageFunValue = CalculatorUtility.CalculateNonCriticalDamage(calculateInfo.BaseDamageFunValue, calculateInfo.BaseRestrainedRate / 100.0);
            calculateInfo.CriticalDamageFunValue = CalculatorUtility.CalculateCriticalDamage(calculateInfo.NonCriticalDamageFunValue, calculateInfo.BaseHit, enemyInfo.Block, (calculateInfo.BaseCriticalRate - 100) / 100.0, calculateInfo.BaseCriticalHits, enemyInfo.AntiCriticalHits, calculateInfo.BaseZtCriticalHitsRate / 100.0, out double newRate);
            calculateInfo.HitRate = (95 + 143 * (calculateInfo.BaseHit + calculateInfo.IncreaseHit) * 1.0 / (calculateInfo.BaseHit + calculateInfo.IncreaseHit + 713) - 143 * enemyInfo.Block * 1.0 / (enemyInfo.Block + 713)) / 100;
            calculateInfo.CalCriticalRate = newRate;
            if (calculateInfo.HitRate > 1)
            {
                calculateInfo.HitRate = 1;
            }

            SaveInfo();

            Snackbar.Add("计算完毕", Severity.Success);
        }
        catch (Exception e)
        {
            Snackbar.Add(ConstText.ExceptionText, Severity.Warning);
        }

        return Task.CompletedTask;
    }

    private void ShowTips()
    {
        Dialog.Show<TipsDialog>("帮助说明", _tipsDialogParameters, _tipsDialogOptions);
    }
}
